<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®æ£€æŸ¥å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .config-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .config-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .config-value {
            color: #6c757d;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-set { background: #d4edda; color: #155724; }
        .status-empty { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        .action-buttons {
            margin-top: 20px;
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .suggestion {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .suggestion h3 {
            margin-top: 0;
            color: #0056b3;
        }
        .suggestion ul {
            margin-bottom: 0;
        }
        .suggestion li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è¯­éŸ³è¾“å…¥åŠ©æ‰‹é…ç½®æ£€æŸ¥</h1>

        <div id="configDisplay">
            <div class="config-item">
                <div class="config-label">æ­£åœ¨åŠ è½½é…ç½®...</div>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="refreshConfig()">ğŸ”„ åˆ·æ–°é…ç½®</button>
            <button onclick="testCurrentConfig()">ğŸ§ª æµ‹è¯•å½“å‰é…ç½®</button>
            <button onclick="openPopup()">âš™ï¸ æ‰“å¼€é…ç½®é¡µé¢</button>
        </div>

        <div id="suggestions" class="suggestion" style="display: none;">
            <h3>ğŸ’¡ å»ºè®®</h3>
            <ul id="suggestionList"></ul>
        </div>
    </div>

    <script>
        // æ£€æŸ¥æ˜¯å¦åœ¨Chromeæ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ
        if (typeof chrome === 'undefined' || !chrome.storage) {
            document.getElementById('configDisplay').innerHTML = `
                <div class="config-item" style="border-left-color: #dc3545;">
                    <div class="config-label">âŒ ç¯å¢ƒæ£€æµ‹å¤±è´¥</div>
                    <div class="config-value">æ­¤é¡µé¢éœ€è¦åœ¨Chromeæ‰©å±•ç¯å¢ƒä¸­è¿è¡Œã€‚è¯·å°†æ­¤æ–‡ä»¶ä½œä¸ºæ‰©å±•çš„ä¸€éƒ¨åˆ†åŠ è½½ï¼Œæˆ–åœ¨æ‰©å±•çš„popupé¡µé¢ä¸­æ‰“å¼€ã€‚</div>
                </div>`;
        } else {
            refreshConfig();
        }

        function refreshConfig() {
            chrome.storage.local.get([
                'modelType', 'apiKey', 'apiSecret', 'customApiUrl',
                'appId', 'accessToken'
            ], function(result) {
                displayConfig(result);
                generateSuggestions(result);
            });
        }

        function displayConfig(config) {
            const display = document.getElementById('configDisplay');
            const modelType = config.modelType || 'volcano';
            const modelName = modelType === 'custom' ? 'è‡ªå®šä¹‰æ¨¡å‹' : 'ç«å±±å¼•æ“';

            let html = `
                <div class="config-item">
                    <div class="config-label">æ¨¡å‹ç±»å‹${getStatusIcon(config.modelType)}</div>
                    <div class="config-value">${modelName} (${modelType})</div>
                </div>
            `;

            if (modelType === 'custom') {
                html += `
                    <div class="config-item">
                        <div class="config-label">è‡ªå®šä¹‰æ¥å£åœ°å€${getStatusIcon(config.customApiUrl)}</div>
                        <div class="config-value">${config.customApiUrl || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-label">APP ID${getStatusIcon(config.appId)}</div>
                        <div class="config-value">${config.appId || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-label">Access Token${getStatusIcon(config.accessToken)}</div>
                        <div class="config-value">${config.accessToken ? 'å·²è®¾ç½® (' + config.accessToken.substring(0, 10) + '...)' : 'æœªè®¾ç½®'}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="config-item">
                        <div class="config-label">AccessKey ID${getStatusIcon(config.apiKey)}</div>
                        <div class="config-value">${config.apiKey || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-label">AccessKey Secret${getStatusIcon(config.apiSecret)}</div>
                        <div class="config-value">${config.apiSecret ? 'å·²è®¾ç½® (' + config.apiSecret.substring(0, 10) + '...)' : 'æœªè®¾ç½®'}</div>
                    </div>
                `;
            }

            display.innerHTML = html;
        }

        function getStatusIcon(value) {
            if (value && value.trim() !== '') {
                return ' <span class="status status-set">å·²è®¾ç½®</span>';
            } else {
                return ' <span class="status status-empty">æœªè®¾ç½®</span>';
            }
        }

        function generateSuggestions(config) {
            const suggestions = [];
            const modelType = config.modelType || 'volcano';

            if (modelType === 'custom') {
                if (!config.customApiUrl) {
                    suggestions.push('è¯·è®¾ç½®è‡ªå®šä¹‰æ¥å£åœ°å€');
                }
                if (!config.appId) {
                    suggestions.push('å»ºè®®è®¾ç½®APP IDï¼ˆæŸäº›æ¨¡å‹å¿…éœ€ï¼‰');
                }
                if (!config.accessToken) {
                    suggestions.push('å»ºè®®è®¾ç½®Access Tokenï¼ˆæŸäº›æ¨¡å‹å¿…éœ€ï¼‰');
                }

                // å¦‚æœæœ‰æ¥å£åœ°å€ï¼Œæ£€æŸ¥æ ¼å¼
                if (config.customApiUrl) {
                    if (!config.customApiUrl.startsWith('ws://') && !config.customApiUrl.startsWith('wss://')) {
                        suggestions.push('æ¥å£åœ°å€åº”è¯¥ä»¥ ws:// æˆ– wss:// å¼€å¤´');
                    }
                    if (config.customApiUrl.includes(' ')) {
                        suggestions.push('æ¥å£åœ°å€ä¸åº”è¯¥åŒ…å«ç©ºæ ¼');
                    }
                }
            } else {
                if (!config.apiKey) {
                    suggestions.push('è¯·è®¾ç½®AccessKey ID');
                }
                if (!config.apiSecret) {
                    suggestions.push('è¯·è®¾ç½®AccessKey Secret');
                }
            }

            // é€šç”¨å»ºè®®
            if (suggestions.length === 0) {
                suggestions.push('é…ç½®çœ‹èµ·æ¥ä¸é”™ï¼å¯ä»¥å°è¯•ä½¿ç”¨è¯­éŸ³è¾“å…¥åŠŸèƒ½ã€‚');
                suggestions.push('ç‚¹å‡»"æµ‹è¯•å½“å‰é…ç½®"æŒ‰é’®æ¥éªŒè¯è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚');
            } else {
                suggestions.push('è¯·å®Œå–„ä¸Šè¿°é…ç½®åä¿å­˜ï¼Œç„¶åé‡æ–°åŠ è½½æ‰©å±•ã€‚');
                suggestions.push('å¯ä»¥ç‚¹å‡»"æ‰“å¼€é…ç½®é¡µé¢"æŒ‰é’®æ¥ä¿®æ”¹é…ç½®ã€‚');
            }

            const suggestionDiv = document.getElementById('suggestions');
            const suggestionList = document.getElementById('suggestionList');

            if (suggestions.length > 0) {
                suggestionList.innerHTML = suggestions.map(s => `<li>${s}</li>`).join('');
                suggestionDiv.style.display = 'block';
            } else {
                suggestionDiv.style.display = 'none';
            }
        }

        function testCurrentConfig() {
            chrome.storage.local.get([
                'modelType', 'apiKey', 'apiSecret', 'customApiUrl',
                'appId', 'accessToken'
            ], function(config) {
                const modelType = config.modelType || 'volcano';

                if (modelType === 'custom') {
                    if (!config.customApiUrl) {
                        alert('è¯·å…ˆè®¾ç½®è‡ªå®šä¹‰æ¥å£åœ°å€');
                        return;
                    }

                    const testUrl = config.customApiUrl;
                    const authParams = [];
                    if (config.appId) authParams.push(`app_id=${config.appId}`);
                    if (config.accessToken) authParams.push(`access_token=${config.accessToken}`);
                    authParams.push(`timestamp=${Date.now()}`);
                    authParams.push(`nonce=${Math.random().toString(36).substr(2, 9)}`);

                    const fullUrl = authParams.length > 0 ? `${testUrl}?${authParams.join('&')}` : testUrl;

                    if (confirm(`å°†æµ‹è¯•ä»¥ä¸‹WebSocketè¿æ¥ï¼š\n\n${fullUrl}\n\nç‚¹å‡»ç¡®å®šå¼€å§‹æµ‹è¯•ã€‚`)) {
                        window.open(`debug_websocket.html?url=${encodeURIComponent(testUrl)}&params=${encodeURIComponent(authParams.join('&'))}`, '_blank');
                    }
                } else {
                    alert('ç«å±±å¼•æ“æ¨¡å‹æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...');
                }
            });
        }

        function openPopup() {
            chrome.runtime.sendMessage({action: 'openPopup'});
            window.close();
        }
    </script>
</body>
</html>