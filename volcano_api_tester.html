<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«å±±å¼•æ“APIè¿æ¥æµ‹è¯•å™¨</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .config-section {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-error { color: #dc3545; }
        .log-success { color: #28a745; }
        .log-info { color: #17a2b8; }
        .log-warning { color: #ffc107; }
        .result-box {
            background: #e7f3ff;
            border: 1px solid #007bff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        .error-box {
            background: #f8d7da;
            border: 1px solid #dc3545;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        .success-box {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .test-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        .test-card h4 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ ç«å±±å¼•æ“è¯­éŸ³è¯†åˆ«APIæµ‹è¯•å™¨</h1>
        <p>ä¸“é—¨æµ‹è¯•ç«å±±å¼•æ“æµå¼è¯­éŸ³è¯†åˆ«APIè¿æ¥çš„å·¥å…·</p>
    </div>

    <div class="container">
        <h2>âš™ï¸ æµ‹è¯•é…ç½®</h2>
        <div class="config-section">
            <div class="form-group">
                <label>APP ID:</label>
                <input type="text" id="appId" value="7547060066" placeholder="è¯·è¾“å…¥APP ID">
            </div>
            <div class="form-group">
                <label>Access Token:</label>
                <input type="text" id="accessToken" value="lIiI3tsagpi2Ynpm_qwbI1zPkKMctNZO" placeholder="è¯·è¾“å…¥Access Token">
            </div>
            <div class="form-group">
                <label>æ¥å£åœ°å€:</label>
                <select id="apiEndpoint">
                    <option value="wss://openspeech.bytedance.com/api/v3/sauc/bigmodel">wss://openspeech.bytedance.com/api/v3/sauc/bigmodel</option>
                    <option value="wss://openspeech.bytedance.com/ws/v1/stream">wss://openspeech.bytedance.com/ws/v1/stream</option>
                    <option value="wss://openspeech.bytedance.com/api/v2/sauc/bigmodel">wss://openspeech.bytedance.com/api/v2/sauc/bigmodel</option>
                    <option value="wss://openspeech.bytedance.com/api/v1/sauc/bigmodel">wss://openspeech.bytedance.com/api/v1/sauc/bigmodel</option>
                    <option value="custom">è‡ªå®šä¹‰åœ°å€</option>
                </select>
            </div>
            <div class="form-group" id="customEndpointGroup" style="display: none;">
                <label>è‡ªå®šä¹‰æ¥å£åœ°å€:</label>
                <input type="text" id="customEndpoint" placeholder="wss://your-api-endpoint.com/path">
            </div>
            <div class="form-group">
                <label>è¿æ¥è¶…æ—¶ (ç§’):</label>
                <select id="timeout">
                    <option value="5">5ç§’</option>
                    <option value="10" selected>10ç§’</option>
                    <option value="15">15ç§’</option>
                    <option value="30">30ç§’</option>
                </select>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="runComprehensiveTest()">ğŸš€ è¿è¡Œç»¼åˆæµ‹è¯•</button>
            <button onclick="testAllEndpoints()">ğŸ”— æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹</button>
            <button onclick="testAuthVariations()">ğŸ”‘ æµ‹è¯•è®¤è¯å˜ä½“</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="testResults">
            <div class="log-area">
                <div class="log-entry log-info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ” è¯Šæ–­åˆ†æ</h2>
        <div id="diagnosticAnalysis">
            <p>è¿è¡Œæµ‹è¯•åå°†æ˜¾ç¤ºè¯¦ç»†çš„è¯Šæ–­åˆ†æ...</p>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“š ç«å±±å¼•æ“APIå‚è€ƒ</h2>
        <div class="test-grid">
            <div class="test-card">
                <h4>ğŸ”§ å®˜æ–¹æ–‡æ¡£</h4>
                <p><a href="https://www.volcengine.com/docs/6561/79838" target="_blank">æµå¼è¯­éŸ³è¯†åˆ«APIæ–‡æ¡£</a></p>
                <p><a href="https://www.volcengine.com/docs/6561/115174" target="_blank">WebSocketæ¥å£è¯´æ˜</a></p>
            </div>
            <div class="test-card">
                <h4>ğŸ”— æ¥å£åœ°å€</h4>
                <ul>
                    <li>wss://openspeech.bytedance.com/ws/v1/stream</li>
                    <li>wss://openspeech.bytedance.com/api/v3/sauc/bigmodel</li>
                </ul>
            </div>
            <div class="test-card">
                <h4>ğŸ”‘ è®¤è¯æ–¹å¼</h4>
                <ul>
                    <li>AccessKey ID + Secret</li>
                    <li>APP ID + Access Token</li>
                </ul>
            </div>
            <div class="test-card">
                <h4>âš ï¸ å¸¸è§é”™è¯¯</h4>
                <ul>
                    <li>1006: è¿æ¥è¢«æ‹’ç»</li>
                    <li>è®¤è¯å‚æ•°é”™è¯¯</li>
                    <li>æ¥å£åœ°å€é”™è¯¯</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ç›‘å¬æ¥å£åœ°å€é€‰æ‹©å˜åŒ–
        document.getElementById('apiEndpoint').addEventListener('change', function() {
            const customGroup = document.getElementById('customEndpointGroup');
            if (this.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        });

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();

            let logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;

            // å¦‚æœå½“å‰æ²¡æœ‰æ—¥å¿—åŒºåŸŸï¼Œåˆ›å»ºä¸€ä¸ª
            if (!resultsDiv.querySelector('.log-area')) {
                resultsDiv.innerHTML = '<div class="log-area"></div>';
            }

            const logArea = resultsDiv.querySelector('.log-area');
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '<div class="log-area"><div class="log-entry log-info">ç»“æœå·²æ¸…ç©º...</div></div>';
            document.getElementById('diagnosticAnalysis').innerHTML = '<p>è¿è¡Œæµ‹è¯•åå°†æ˜¾ç¤ºè¯¦ç»†çš„è¯Šæ–­åˆ†æ...</p>';
        }

        async function runComprehensiveTest() {
            const appId = document.getElementById('appId').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            const endpointSelect = document.getElementById('apiEndpoint');
            const timeout = parseInt(document.getElementById('timeout').value) * 1000;

            let endpoint = endpointSelect.value;
            if (endpoint === 'custom') {
                endpoint = document.getElementById('customEndpoint').value.trim();
                if (!endpoint) {
                    log('è¯·è¾“å…¥è‡ªå®šä¹‰æ¥å£åœ°å€', 'error');
                    return;
                }
            }

            if (!appId || !accessToken) {
                log('è¯·è¾“å…¥å®Œæ•´çš„APP IDå’ŒAccess Token', 'error');
                return;
            }

            clearResults();
            log('ğŸš€ å¼€å§‹ç»¼åˆæµ‹è¯•...', 'info');
            log(`APP ID: ${appId}`, 'info');
            log(`Access Token: ${accessToken.substring(0, 10)}...`, 'info');
            log(`æ¥å£åœ°å€: ${endpoint}`, 'info');
            log(`è¶…æ—¶æ—¶é—´: ${timeout/1000}ç§’`, 'info');

            // æ„å»ºè®¤è¯å‚æ•°
            const timestamp = Date.now();
            const nonce = Math.random().toString(36).substr(2, 9);
            const authParams = `app_id=${appId}&access_token=${accessToken}&timestamp=${timestamp}&nonce=${nonce}`;
            const fullUrl = `${endpoint}?${authParams}`;

            log(`å®Œæ•´URL: ${fullUrl}`, 'info');

            // å¼€å§‹è¿æ¥æµ‹è¯•
            await testWebSocketConnection(fullUrl, endpoint, authParams, timeout);
        }

        async function testWebSocketConnection(fullUrl, baseUrl, authParams, timeout) {
            return new Promise((resolve) => {
                log('\nğŸ”„ å¼€å§‹WebSocketè¿æ¥æµ‹è¯•...', 'info');

                try {
                    const ws = new WebSocket(fullUrl);
                    const startTime = Date.now();
                    let connectionEstablished = false;

                    const timeoutId = setTimeout(() => {
                        if (!connectionEstablished) {
                            log('â° è¿æ¥è¶…æ—¶', 'error');
                            ws.close();
                            analyzeConnectionFailure(baseUrl, authParams, 'timeout');
                            resolve();
                        }
                    }, timeout);

                    ws.onopen = () => {
                        connectionEstablished = true;
                        clearTimeout(timeoutId);
                        const connectTime = Date.now() - startTime;
                        log(`âœ… è¿æ¥æˆåŠŸï¼è€—æ—¶: ${connectTime}ms`, 'success');

                        // å‘é€æµ‹è¯•æ•°æ®
                        try {
                            ws.send(JSON.stringify({
                                type: 'test',
                                message: 'Hello from test client',
                                timestamp: Date.now()
                            }));
                            log('ğŸ“¤ æµ‹è¯•æ•°æ®å·²å‘é€', 'info');
                        } catch (e) {
                            log(`å‘é€æ•°æ®å¤±è´¥: ${e.message}`, 'error');
                        }

                        setTimeout(() => {
                            ws.close();
                            log('è¿æ¥å·²å…³é—­', 'info');
                            resolve();
                        }, 2000);
                    };

                    ws.onmessage = (event) => {
                        log(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'success');
                        analyzeServerResponse(event.data);
                    };

                    ws.onerror = (error) => {
                        clearTimeout(timeoutId);
                        log(`âŒ è¿æ¥é”™è¯¯: ${error.type}`, 'error');
                        analyzeConnectionFailure(baseUrl, authParams, error);
                        resolve();
                    };

                    ws.onclose = (event) => {
                        if (!connectionEstablished) {
                            clearTimeout(timeoutId);
                        }

                        log(`è¿æ¥å…³é—­ - ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æœªçŸ¥'}`, 'info');

                        if (event.code === 1006) {
                            log('ğŸ” æ£€æµ‹åˆ°1006é”™è¯¯ - è¿æ¥è¢«å¼‚å¸¸å…³é—­', 'warning');
                            if (!connectionEstablished) {
                                analyzeConnectionFailure(baseUrl, authParams, '1006');
                            }
                        }

                        resolve();
                    };

                } catch (error) {
                    log(`åˆ›å»ºWebSocketå¤±è´¥: ${error.message}`, 'error');
                    resolve();
                }
            });
        }

        function analyzeConnectionFailure(url, authParams, errorType) {
            const analysisDiv = document.getElementById('diagnosticAnalysis');
            let analysisHtml = '<h3>ğŸ” è¿æ¥å¤±è´¥åˆ†æ</h3>';

            analysisHtml += '<div class="error-box">';
            analysisHtml += `<h4>é”™è¯¯ç±»å‹: ${errorType}</h4>`;
            analysisHtml += `<p><strong>æ¥å£åœ°å€:</strong> ${url}</p>`;
            analysisHtml += `<p><strong>è®¤è¯å‚æ•°:</strong> ${authParams}</p>`;
            analysisHtml += '</div>';

            analysisHtml += '<h4>ğŸ” å¯èƒ½çš„åŸå› :</h4>';
            analysisHtml += '<ul>';

            if (errorType === '1006') {
                analysisHtml += '<li><strong>è®¤è¯å¤±è´¥:</strong> APP IDæˆ–Access Tokenå¯èƒ½æ— æ•ˆ</li>';
                analysisHtml += '<li><strong>æ¥å£åœ°å€é”™è¯¯:</strong> å¯èƒ½ä½¿ç”¨äº†é”™è¯¯çš„APIç«¯ç‚¹</li>';
                analysisHtml += '<li><strong>å‚æ•°æ ¼å¼é”™è¯¯:</strong> è®¤è¯å‚æ•°æ ¼å¼å¯èƒ½ä¸ç¬¦åˆè¦æ±‚</li>';
                analysisHtml += '<li><strong>æœåŠ¡æœªå¯ç”¨:</strong> è¯­éŸ³è¯†åˆ«æœåŠ¡å¯èƒ½æœªåœ¨æ§åˆ¶å°å¯ç”¨</li>';
            } else if (errorType === 'timeout') {
                analysisHtml += '<li><strong>ç½‘ç»œè¶…æ—¶:</strong> è¿æ¥è¯·æ±‚è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜</li>';
                analysisHtml += '<li><strong>æœåŠ¡å™¨æ— å“åº”:</strong> æœåŠ¡å™¨å¯èƒ½æ²¡æœ‰å“åº”WebSocketè¿æ¥</li>';
            } else {
                analysisHtml += '<li><strong>ç½‘ç»œé—®é¢˜:</strong> å¯èƒ½å­˜åœ¨ç½‘ç»œè¿æ¥é—®é¢˜</li>';
                analysisHtml += '<li><strong>æµè§ˆå™¨é™åˆ¶:</strong> æµè§ˆå™¨å®‰å…¨ç­–ç•¥å¯èƒ½é˜»æ­¢è¿æ¥</li>';
            }

            analysisHtml += '</ul>';

            analysisHtml += '<h4>ğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ:</h4>';
            analysisHtml += '<ul>';
            analysisHtml += '<li>éªŒè¯APP IDå’ŒAccess Tokenæ˜¯å¦æ­£ç¡®</li>';
            analysisHtml += '<li>å°è¯•ä½¿ç”¨ä¸åŒçš„æ¥å£åœ°å€</li>';
            analysisHtml += '<li>æ£€æŸ¥ç«å±±å¼•æ“æ§åˆ¶å°ä¸­çš„æœåŠ¡çŠ¶æ€</li>';
            analysisHtml += '<li>ç¡®è®¤è¯­éŸ³è¯†åˆ«æœåŠ¡å·²å¯ç”¨</li>';
            analysisHtml += '<li>è”ç³»ç«å±±å¼•æ“æŠ€æœ¯æ”¯æŒç¡®è®¤æ¥å£çŠ¶æ€</li>';
            analysisHtml += '</ul>';

            analysisDiv.innerHTML = analysisHtml;
        }

        function analyzeServerResponse(data) {
            try {
                const response = JSON.parse(data);
                log('ğŸ“Š æœåŠ¡å™¨å“åº”åˆ†æ:', 'info');
                log(`å“åº”ç±»å‹: ${response.type || 'æœªçŸ¥'}`, 'info');

                if (response.error) {
                    log(`âŒ æœåŠ¡å™¨é”™è¯¯: ${JSON.stringify(response.error)}`, 'error');
                }

                if (response.code) {
                    log(`å“åº”ä»£ç : ${response.code}`, 'info');
                }

            } catch (e) {
                log(`åŸå§‹å“åº”: ${data}`, 'info');
            }
        }

        async function testAllEndpoints() {
            const endpoints = [
                'wss://openspeech.bytedance.com/ws/v1/stream',
                'wss://openspeech.bytedance.com/api/v1/sauc/bigmodel',
                'wss://openspeech.bytedance.com/api/v2/sauc/bigmodel',
                'wss://openspeech.bytedance.com/api/v3/sauc/bigmodel'
            ];

            const appId = document.getElementById('appId').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            const timeout = parseInt(document.getElementById('timeout').value) * 1000;

            if (!appId || !accessToken) {
                log('è¯·è¾“å…¥APP IDå’ŒAccess Token', 'error');
                return;
            }

            clearResults();
            log('ğŸ”„ å¼€å§‹æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹...', 'info');

            for (let i = 0; i < endpoints.length; i++) {
                const endpoint = endpoints[i];
                log(`\nğŸ“ æµ‹è¯•ç«¯ç‚¹ ${i + 1}/${endpoints.length}: ${endpoint}`, 'info');

                const timestamp = Date.now();
                const nonce = Math.random().toString(36).substr(2, 9);
                const authParams = `app_id=${appId}&access_token=${accessToken}&timestamp=${timestamp}&nonce=${nonce}`;
                const fullUrl = `${endpoint}?${authParams}`;

                await testWebSocketConnection(fullUrl, endpoint, authParams, timeout);

                // ç­‰å¾…3ç§’å†æµ‹è¯•ä¸‹ä¸€ä¸ª
                if (i < endpoints.length - 1) {
                    log('ç­‰å¾…3ç§’åç»§ç»­æµ‹è¯•...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }
            }
        }

        async function testAuthVariations() {
            const appId = document.getElementById('appId').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            const endpoint = document.getElementById('apiEndpoint').value;
            const timeout = parseInt(document.getElementById('timeout').value) * 1000;

            if (!appId || !accessToken) {
                log('è¯·è¾“å…¥APP IDå’ŒAccess Token', 'error');
                return;
            }

            clearResults();
            log('ğŸ”„ å¼€å§‹æµ‹è¯•è®¤è¯å‚æ•°å˜ä½“...', 'info');

            const authVariations = [
                {
                    name: 'æ ‡å‡†æ ¼å¼',
                    params: `app_id=${appId}&access_token=${accessToken}`
                },
                {
                    name: 'å¸¦æ—¶é—´æˆ³',
                    params: `app_id=${appId}&access_token=${accessToken}&timestamp=${Date.now()}`
                },
                {
                    name: 'å¸¦éšæœºæ•°',
                    params: `app_id=${appId}&access_token=${accessToken}&nonce=${Math.random().toString(36).substr(2, 9)}`
                },
                {
                    name: 'å®Œæ•´æ ¼å¼',
                    params: `app_id=${appId}&access_token=${accessToken}&timestamp=${Date.now()}&nonce=${Math.random().toString(36).substr(2, 9)}`
                }
            ];

            for (let i = 0; i < authVariations.length; i++) {
                const variation = authVariations[i];
                log(`\nğŸ”‘ æµ‹è¯•è®¤è¯å˜ä½“ ${i + 1}/${authVariations.length}: ${variation.name}`, 'info');
                log(`å‚æ•°: ${variation.params}`, 'info');

                const fullUrl = `${endpoint}?${variation.params}`;
                await testWebSocketConnection(fullUrl, endpoint, variation.params, timeout);

                // ç­‰å¾…2ç§’å†æµ‹è¯•ä¸‹ä¸€ä¸ª
                if (i < authVariations.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            setTimeout(() => {
                log('ğŸš€ ç«å±±å¼•æ“APIæµ‹è¯•å™¨å·²åŠ è½½', 'info');
                log('ğŸ’¡ å»ºè®®å…ˆè¿è¡Œ"æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹"æ¥æ‰¾åˆ°å¯ç”¨çš„æ¥å£', 'info');
            }, 100);
        };
    </script>
</body>
</html>